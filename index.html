<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>文曲星模拟器</title>
    <script src="src/m65c02.js"></script>
    <!--<script src="refs/logs.txt"></script>-->
    <script src="src/wqx.js"></script>
    <script src="src/keypad.js"></script>
    <style>
        #wqx {
            width: 320px;
            height: 160px;
            background-color: #98fb98;
        }
    </style>
</head>
<body>
<h1>文曲星模拟器</h1>
<button id="run" onclick="run();" disabled>run</button>
<button id="stop" onclick="stop();" disabled>stop</button>
<button id="reset" onclick="reset();">reset</button>
<button id="load_demo" onclick="loadDemo();">loadDemo</button>
<div id="wqx"></div>
<div>
    <button id="toogle_keypad">软键盘 开/关</button>
    <label><input tabindex="0" id="input" type="text" placeholder="键盘输入" style="ime-mode: disabled;"/></label>
</div>
<div id="keypad">

</div>
<p>
    <span>orginal: <a href="http://bbs.emsky.net/viewthread.php?tid=33474">http://bbs.emsky.net/viewthread.php?tid=33474</a><br/>
        目前只在chrome浏览器测试过，别的浏览器应该也有能跑的。<br/>
        由于ROM文件有16M之大，若加载过慢，请自行下载到硬盘上，拖拽到模拟器的屏幕区域手动加载。<br/>
        若想要离线使用能正常加载，请在chrome启动参数中加入`--allow-file-access-from-files`。<br/>
        <a href="./rom/obj.bin">ROM文件下载地址</a></span>
</p>
<script>
    var div = document.getElementById('wqx');
    var wqx = new Wqx(div);
    var keypad = new WqxKeypad(wqx, document.getElementById('input'));

    var romLoaded = false;
    var norLoaded = false;
    var xhrRom = null;
    function check(){
        if (romLoaded && norLoaded) {
            document.getElementById('run').removeAttribute('disabled');
        }
    }
    div.addEventListener('dragover', function (evt){
        evt.preventDefault();
    });
    div.addEventListener('drop', function (evt){
        var file;
        try {
            file = evt.dataTransfer.files[0];
        } catch(ex){}
        var fileReader = new FileReader();
        fileReader.addEventListener('loadend', function (evt){
            if (!xhrRom) {
                xhrRom.abort();
                xhrRom = null;
            }
            wqx.loadBROM(fileReader.result);
            romLoaded = true;
            check();
        });
        fileReader.readAsArrayBuffer(file);
        evt.preventDefault();
    });

    function loadDemo(){
        var xhrNor = new XMLHttpRequest();
        xhrNor.responseType = 'arraybuffer';
        xhrNor.open('GET', './rom/cc800.fls', true);
        xhrNor.addEventListener('loadend', function (){
            wqx.loadNorFlash(xhrNor.response);
            norLoaded = true;
            check();
        });
        xhrNor.send();
        // todo: progress info
        document.getElementById('load_demo').setAttribute('disabled', 'disabled');
        xhrRom = new XMLHttpRequest();
        xhrRom.responseType = 'arraybuffer';
        xhrRom.addEventListener('progress', function (evt){
            document.getElementById('load_demo').innerHTML = 'ROM加载中 ' + evt.loaded + '/' + evt.total;
        });
        xhrRom.addEventListener('loadend', function (){
            document.getElementById('load_demo').innerHTML = 'ROM加载完毕';
            wqx.loadBROM(xhrRom.response);
            romLoaded = true;
            check();
        });
        xhrRom.open('GET', './rom/obj.bin', true);
        xhrRom.send();

    }

    function run(){
        wqx.run();
        document.getElementById('run').setAttribute('disabled', 'disabled');
        document.getElementById('stop').removeAttribute('disabled');
    }
    function stop(){
        wqx.stop();
        document.getElementById('stop').setAttribute('disabled', 'disabled');
        document.getElementById('run').removeAttribute('disabled');
    }
    function reset(){
        wqx.reset();
    }

</script>
</body>
</html>